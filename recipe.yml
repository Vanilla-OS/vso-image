base: ghcr.io/vanilla-os/pico:main
name: Vanilla VSO
id: vanilla-vso
labels:
  maintainer: Vanilla OS Contributors
args:
  DEBIAN_FRONTEND: noninteractive
runs:
  - echo 'APT::Install-Recommends "0";' > /etc/apt/apt.conf.d/01norecommends

modules:
  - name: systemd
    type: apt
    source:
      packages:
        - systemd
        - libpam-systemd
        # pre-install distrobox-init pkgs
        - apt-utils
        - bash-completion
        - bc
        - curl
        - dialog
        - diffutils
        - findutils
        - gnupg2
        - less
        - libnss-myhostname
        - libvte-2.9*-common
        - libvte-common
        - locales
        - lsof
        - ncurses-base
        - passwd
        - pinentry-curses
        - procps
        - sudo
        - time
        - tzdata
        - util-linux
        - wget
        - libegl1-mesa
        - libgl1-mesa-glx
        - libvulkan1
        - mesa-vulkan-drivers

  - name: vanilla-tools
    type: shell
    source:
      type: tar
      # switch to production build once in production
      url: https://github.com/Vanilla-OS/vanilla-tools/releases/download/continuous/vanilla-tools.tar.gz
    commands:
    - mkdir -p /usr/bin
    - cp /sources/vanilla-tools/nrun /usr/bin/nrun
    - chmod +x /usr/bin/nrun
    - cp /sources/vanilla-tools/cur-gpu /usr/bin/cur-gpu
    - chmod +x /usr/bin/cur-gpu

  - name: host-aliases
    type: shell
    commands:
      - ln -s /usr/bin/host-spawn /usr/bin/vso
      - ln -s /usr/bin/host-spawn /usr/bin/abroot
      - ln -s /usr/bin/host-spawn /usr/bin/apx
      - ln -s /usr/bin/host-spawn /usr/bin/ikaros
      - ln -s /usr/bin/host-spawn /usr/bin/vanilla-sideload
      - sh /usr/share/apx/distrobox/gen-distrobox-links

  - name: cleanup
    type: shell
    commands:
      - apt autoremove -y
      - apt clean

  - name: enable-apt-hooks
    type: shell
    commands:
      - mv /etc/apt/___apt.conf.d/ /etc/apt/apt.conf.d/
